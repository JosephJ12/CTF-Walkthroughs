# Vintage

**Platform: Hack the Box**

**OS: Windows**

**Diffculty: Hard**


## Table of Contents
- [Key Learnings](#key-learnings)
- [Walkthrough](#walkthrough)
- [Remediation Summary](#remediation-summary)


## Key Learnings

- Familiarize myself with enumerating AD networks using Bloodhound
- Use ldapsearch for AD enumeration
- Learned that Netexec by default filters out machine accounts when kerberoasting because machine accounts normally have very strong passwords set by default. However, this is not always the case like here, and is kerberoastable/crackable.
- Found what security implementations the Protected Users group has by default (Stronger AES encryption on TGTs, disabling NTLM hash and caching credentials, TGTs expire in 4 hours, etc.)
- Learned that having AddMember privileges can also mean having RemoveMember rights. Also learned that one can remove not only users from groups, but groups from groups using bloodyAD
- Became familiar with using tools that don't rely on SMB and use Kerberos authentication (ldapsearch and bloodyAD -k vs net rpc)


## **Disclaimer: Potential spoilers below**


## Walkthrough

1. Run nmap scan

<img width="910" height="512" alt="image" src="https://github.com/user-attachments/assets/2e7f4510-5dd6-4c18-8edb-6eae734e1d96" />

2. Ldap port 389 confirms we're dealing with a Windows Domain Controller. The very first thing I try with domain user credentials is kerberoasting using Impacket's GetUserSPNs.py

`GetUserSPNs.py vintage.htb/p.rosa:Rosaisbest123 -dc-ip 10.129.85.186 -request`

<img width="915" height="148" alt="image" src="https://github.com/user-attachments/assets/744fc9e1-7d01-4922-a5a8-a5bbb7be34c6" />

3. However, we run into an error saying NTLM is disabled. So try again with the `-k` flag for kerberos authentication

`GetUserSPNs.py vintage.htb/p.rosa:Rosaisbest123 -dc-ip 10.129.85.186 -request -k -dc-host dc.vintage.htb`

<img width="914" height="143" alt="image" src="https://github.com/user-attachments/assets/76ce253d-4a40-4d6d-a1ab-454be4d43b3c" />

4. After trying other dead ends (like SMB enumeration and AS-REP Roasting after getting a list of usernames with NetExec LDAP), we try kerberoasting again but this time, with NetExec and the debug flag

`nxc ldap dc01.vintage.htb -u p.rosa -p 'Rosaisbest123' -d vintage.htb -k --kerberoasting kerberoast.txt --debug`

<img width="912" height="839" alt="image" src="https://github.com/user-attachments/assets/fb8b93c3-6efb-48e8-abae-f27c92162d73" />

5. It turns out, NetExec by default removes machine accounts from the Kerberoast search filter. This is because machine account hashes are normally generated by the machine and are nearly uncrackeable. However, there may be exceptions so we change the filter to include them and try again. We do this by modifying the ldap.py file

`nxc ldap dc01.vintage.htb -u p.rosa -p 'Rosaisbest123' -d vintage.htb -k --kerberoasting kerberoast.txt --debug`

<img width="727" height="243" alt="image" src="https://github.com/user-attachments/assets/ed885d47-ef6d-4987-b1e0-6ce67090e499" />

6. This time, it's a success! We get 2 hashes and we crack them offline with hashcat.

`hashcat -m 13100 kerberoast.txt /usr/share/wordlists/rockyou.txt`

<img width="1733" height="475" alt="image" src="https://github.com/user-attachments/assets/b2faa4f8-b1e2-4076-9992-832d48a7c7e0" />

7. However, they are not crackeable. With no other leads left, I try kerberoasting one last time with Impacket's GetUserSPNs script and giving it the list of usernames. And success! We got one more hash for the krbtgt account

`GetUserSPNs.py vintage.htb/P.Rosa:Rosaisbest123 -dc-ip 10.129.85.186 -request -k -dc-host dc01.vintage.htb -usersfile users.list`

<img width="915" height="879" alt="image" src="https://github.com/user-attachments/assets/798df541-b7b5-4230-b40e-8202e122270f" />

8. Since this is a $krb5tgs$18 hash, we attempt to crack offline using hashcat module 19700

`hashcat -m 19700 krbtgt_kerberoast.hash /usr/share/wordlists/rockyou.txt`



9. 

